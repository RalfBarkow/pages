{
  "title": "Upgrade Interruption 2021-06",
  "story": [
    {
      "type": "paragraph",
      "id": "960bbb2f00a23348",
      "text": "Apple, like many others, pesters with red dots—little Red Queens to race again in Wonderland. Last night we stopped postponing Mac OS 11.4. This morning confirmed our reluctance. Unplanned work greeted us: local wiki was no longer working. To return to service we re-learn our local deploy and learn new corners of keeping up with The Internet. We offer these notes with many hopes: perhaps our future self can untangle a future knot, perhaps our collaborators can be spared a few extra minutes, perhaps future wiki admins can plan for a little slack in their schedule. Interruptions abound."
    },
    {
      "type": "paragraph",
      "id": "c3086d5b1313e362",
      "text": "See [[Bit Rot and Red Queen Effect]]."
    },
    {
      "type": "paragraph",
      "id": "b73186404973dbd7",
      "text": "See [[Tempo Interruptions]]."
    },
    {
      "type": "graphviz",
      "id": "b0543da838848298",
      "text": "digraph {\n  rankdir=LR\n  node [shape=box style=\"rounded,filled\"]\n\n\"Upgrade\\nMacOS\"\n-> \"Upgrade k3d\\nto 4.x\"\n-> \"Upgrade k8s\\nto 1.21\"\n-> \"Update ingress\\nconfig\"\n-> \"Write a\\nwiki page\"\n}",
      "dot": "digraph {\n  rankdir=LR\n  node [shape=box style=\"rounded,filled\"]\n\n\"Upgrade\\nMacOS\"\n-> \"Upgrade k3d\\nto 4.x\"\n-> \"Upgrade k8s\\nto 1.21\"\n-> \"Update ingress\\nconfig\"\n-> \"Write a\\nwiki page\"\n}",
      "svg": "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 8.0.5 (0)\n -->\n<!-- Pages: 1 -->\n<svg width=\"562pt\" height=\"50pt\"\n viewBox=\"0.00 0.00 562.46 49.60\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 45.6)\">\n<polygon fill=\"white\" stroke=\"none\" points=\"-4,4 -4,-45.6 558.46,-45.6 558.46,4 -4,4\"/>\n<!-- Upgrade\\nMacOS -->\n<g id=\"node1\" class=\"node\">\n<title>Upgrade\\nMacOS</title>\n<path fill=\"lightgrey\" stroke=\"black\" d=\"M52.2,-41.6C52.2,-41.6 12,-41.6 12,-41.6 6,-41.6 0,-35.6 0,-29.6 0,-29.6 0,-12 0,-12 0,-6 6,0 12,0 12,0 52.2,0 52.2,0 58.2,0 64.2,-6 64.2,-12 64.2,-12 64.2,-29.6 64.2,-29.6 64.2,-35.6 58.2,-41.6 52.2,-41.6\"/>\n<text text-anchor=\"middle\" x=\"32.1\" y=\"-25\" font-family=\"Times,serif\" font-size=\"14.00\">Upgrade</text>\n<text text-anchor=\"middle\" x=\"32.1\" y=\"-8.2\" font-family=\"Times,serif\" font-size=\"14.00\">MacOS</text>\n</g>\n<!-- Upgrade k3d\\nto 4.x -->\n<g id=\"node2\" class=\"node\">\n<title>Upgrade k3d\\nto 4.x</title>\n<path fill=\"lightgrey\" stroke=\"black\" d=\"M176.9,-41.6C176.9,-41.6 112.2,-41.6 112.2,-41.6 106.2,-41.6 100.2,-35.6 100.2,-29.6 100.2,-29.6 100.2,-12 100.2,-12 100.2,-6 106.2,0 112.2,0 112.2,0 176.9,0 176.9,0 182.9,0 188.9,-6 188.9,-12 188.9,-12 188.9,-29.6 188.9,-29.6 188.9,-35.6 182.9,-41.6 176.9,-41.6\"/>\n<text text-anchor=\"middle\" x=\"144.55\" y=\"-25\" font-family=\"Times,serif\" font-size=\"14.00\">Upgrade k3d</text>\n<text text-anchor=\"middle\" x=\"144.55\" y=\"-8.2\" font-family=\"Times,serif\" font-size=\"14.00\">to 4.x</text>\n</g>\n<!-- Upgrade\\nMacOS&#45;&gt;Upgrade k3d\\nto 4.x -->\n<g id=\"edge1\" class=\"edge\">\n<title>Upgrade\\nMacOS&#45;&gt;Upgrade k3d\\nto 4.x</title>\n<path fill=\"none\" stroke=\"black\" d=\"M64.46,-20.8C72.08,-20.8 80.46,-20.8 88.83,-20.8\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"88.75,-24.3 98.75,-20.8 88.75,-17.3 88.75,-24.3\"/>\n</g>\n<!-- Upgrade k8s\\nto 1.21 -->\n<g id=\"node3\" class=\"node\">\n<title>Upgrade k8s\\nto 1.21</title>\n<path fill=\"lightgrey\" stroke=\"black\" d=\"M300.05,-41.6C300.05,-41.6 236.9,-41.6 236.9,-41.6 230.9,-41.6 224.9,-35.6 224.9,-29.6 224.9,-29.6 224.9,-12 224.9,-12 224.9,-6 230.9,0 236.9,0 236.9,0 300.05,0 300.05,0 306.05,0 312.05,-6 312.05,-12 312.05,-12 312.05,-29.6 312.05,-29.6 312.05,-35.6 306.05,-41.6 300.05,-41.6\"/>\n<text text-anchor=\"middle\" x=\"268.47\" y=\"-25\" font-family=\"Times,serif\" font-size=\"14.00\">Upgrade k8s</text>\n<text text-anchor=\"middle\" x=\"268.47\" y=\"-8.2\" font-family=\"Times,serif\" font-size=\"14.00\">to 1.21</text>\n</g>\n<!-- Upgrade k3d\\nto 4.x&#45;&gt;Upgrade k8s\\nto 1.21 -->\n<g id=\"edge2\" class=\"edge\">\n<title>Upgrade k3d\\nto 4.x&#45;&gt;Upgrade k8s\\nto 1.21</title>\n<path fill=\"none\" stroke=\"black\" d=\"M189.22,-20.8C197.12,-20.8 205.43,-20.8 213.57,-20.8\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"213.52,-24.3 223.52,-20.8 213.52,-17.3 213.52,-24.3\"/>\n</g>\n<!-- Update ingress\\nconfig -->\n<g id=\"node4\" class=\"node\">\n<title>Update ingress\\nconfig</title>\n<path fill=\"lightgrey\" stroke=\"black\" d=\"M435.64,-41.6C435.64,-41.6 360.05,-41.6 360.05,-41.6 354.05,-41.6 348.05,-35.6 348.05,-29.6 348.05,-29.6 348.05,-12 348.05,-12 348.05,-6 354.05,0 360.05,0 360.05,0 435.64,0 435.64,0 441.64,0 447.64,-6 447.64,-12 447.64,-12 447.64,-29.6 447.64,-29.6 447.64,-35.6 441.64,-41.6 435.64,-41.6\"/>\n<text text-anchor=\"middle\" x=\"397.84\" y=\"-25\" font-family=\"Times,serif\" font-size=\"14.00\">Update ingress</text>\n<text text-anchor=\"middle\" x=\"397.84\" y=\"-8.2\" font-family=\"Times,serif\" font-size=\"14.00\">config</text>\n</g>\n<!-- Upgrade k8s\\nto 1.21&#45;&gt;Update ingress\\nconfig -->\n<g id=\"edge3\" class=\"edge\">\n<title>Upgrade k8s\\nto 1.21&#45;&gt;Update ingress\\nconfig</title>\n<path fill=\"none\" stroke=\"black\" d=\"M312.24,-20.8C320.18,-20.8 328.61,-20.8 336.95,-20.8\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"336.81,-24.3 346.81,-20.8 336.81,-17.3 336.81,-24.3\"/>\n</g>\n<!-- Write a\\nwiki page -->\n<g id=\"node5\" class=\"node\">\n<title>Write a\\nwiki page</title>\n<path fill=\"lightgrey\" stroke=\"black\" d=\"M542.46,-41.6C542.46,-41.6 495.64,-41.6 495.64,-41.6 489.64,-41.6 483.64,-35.6 483.64,-29.6 483.64,-29.6 483.64,-12 483.64,-12 483.64,-6 489.64,0 495.64,0 495.64,0 542.46,0 542.46,0 548.46,0 554.46,-6 554.46,-12 554.46,-12 554.46,-29.6 554.46,-29.6 554.46,-35.6 548.46,-41.6 542.46,-41.6\"/>\n<text text-anchor=\"middle\" x=\"519.05\" y=\"-25\" font-family=\"Times,serif\" font-size=\"14.00\">Write a</text>\n<text text-anchor=\"middle\" x=\"519.05\" y=\"-8.2\" font-family=\"Times,serif\" font-size=\"14.00\">wiki page</text>\n</g>\n<!-- Update ingress\\nconfig&#45;&gt;Write a\\nwiki page -->\n<g id=\"edge4\" class=\"edge\">\n<title>Update ingress\\nconfig&#45;&gt;Write a\\nwiki page</title>\n<path fill=\"none\" stroke=\"black\" d=\"M448.02,-20.8C456.04,-20.8 464.32,-20.8 472.25,-20.8\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"472.18,-24.3 482.18,-20.8 472.18,-17.3 472.18,-24.3\"/>\n</g>\n</g>\n</svg>\n"
    },
    {
      "type": "paragraph",
      "id": "8d4b3ebc365db3a1",
      "text": "See also [[Yak Shaving]]."
    },
    {
      "type": "paragraph",
      "id": "bf3d9356326f36cf",
      "text": "What follows is a play-by-play of our troubleshooting."
    },
    {
      "type": "paragraph",
      "id": "e22dc4d84f5c3fdc",
      "text": "The first symptom appeared after a Restore Previous Session in Firefox. [http://localhost http://localhost] and [http://today.localhost http://today.localhost] won't open."
    },
    {
      "type": "paragraph",
      "id": "76b9dd74807a4774",
      "text": "Is our wiki running?"
    },
    {
      "type": "code",
      "id": "c52160e042761003",
      "text": "kubectl get all"
    },
    {
      "type": "paragraph",
      "id": "bb0b694c9d000338",
      "text": "We see deployment.apps/wiki-deployment and service/wiki-service which are our usual confirmations."
    },
    {
      "type": "paragraph",
      "id": "e578cb7cf4d2af0a",
      "text": "Are we getting logs?"
    },
    {
      "type": "code",
      "id": "eb13233e57692c1a",
      "text": "kubectl logs deployment/wiki-deployment\n\n"
    },
    {
      "type": "code",
      "id": "3417f87e5876dfe9",
      "text": "// kubernetes replies...\nWiki starting in Farm mode, navigate to a specific server to start it."
    },
    {
      "type": "paragraph",
      "id": "8dce39694eaf41dc",
      "text": "That suggests the requests from Firefox are not making it all the way into our container. The wiki farm has started, but no requests have landed yet."
    },
    {
      "type": "paragraph",
      "id": "15e237b90569a711",
      "text": "We dig deeper into our memory... which containers run kubernetes again?"
    },
    {
      "type": "code",
      "id": "56991842404f0f1d",
      "text": "$ docker ps --format '{{.Names}} {{.Ports}}'\nk3d-wiki-serverlb 0.0.0.0:80->80/tcp, :::80->80/tcp, 0.0.0.0:51501->6443/tcp\nk3d-wiki-server-0"
    },
    {
      "type": "paragraph",
      "id": "1c6baf379ff388e7",
      "text": "k3d-wiki-serverlb is listening on port 80."
    },
    {
      "type": "code",
      "id": "d5c346599fa3b833",
      "text": "docker logs --tail=200 k3d-wiki-serverlb"
    },
    {
      "type": "paragraph",
      "id": "a3091c5ad10216ef",
      "text": "We recall that these logs showed problems finding the upstream server—it is all fixed at the time of this writing, so we no longer have a copy of the logs to show you, Dear Reader."
    },
    {
      "type": "paragraph",
      "id": "2e0b0ec0b463c2c2",
      "text": "Docker was seeing the traffic from Firefox, but failing to connect through the docker and k3d machinery into the wiki container."
    },
    {
      "type": "paragraph",
      "id": "9a9e9e3b0f43c35d",
      "text": "At the time of our troubleshooting, we only vaguely remembered exactly how all the parts play together. While composing this page, we have found a diagram which has some of the parts. See [[Local Kubernetes Wiki]]."
    },
    {
      "type": "paragraph",
      "id": "34ded1f175334cb4",
      "text": "Back to the story, we shifted at this point from investigation and started with speculative interventions."
    },
    {
      "type": "paragraph",
      "id": "7f89578509210edc",
      "text": "What version of k3d are we running?"
    },
    {
      "type": "code",
      "id": "a9a2be9f3abfbe03",
      "text": "k3d --version"
    },
    {
      "type": "paragraph",
      "id": "e58ff52de1ce01ea",
      "text": "We were on version 3.x. Current k3d is now 4.x. So we upgrade. There was a moment not documented in this story where we also did a bit of investigation to confirm that we did use homebrew to install k3d."
    },
    {
      "type": "code",
      "id": "2a74cae392424228",
      "text": "k3d cluster delete wiki\nbrew upgrade k3d"
    },
    {
      "type": "paragraph",
      "id": "831901168a278b20",
      "text": "How did we create the local k8s cluster, originally?"
    },
    {
      "type": "paragraph",
      "id": "652cd33dc158a649",
      "text": "Is it in our dotfiles? Or in that unfinished github repo?"
    },
    {
      "type": "paragraph",
      "id": "170eff2ec46e84fd",
      "text": "Turns out both: [https://github.com/dobbs/dotfiles/blob/963b8884256309dc8ac6d0efc2bf8d630557ab89/install.d/install-k3d-cluster#L6-L12 dotfiles]  [https://github.com/dobbs/deploy.wiki.do/blob/2a387bc41d4b2efaee96c946febe715875b434db/assets/bin/install-k8s-wiki.sh#L7-L13 repo]"
    },
    {
      "type": "code",
      "id": "465ab94edb562ff9",
      "text": "k3d cluster create wiki \\\n  --k3s-server-arg --tls-san=\"127.0.0.1\" \\\n  --port 80:80@loadbalancer \\\n  --volume \"$HOME/.wiki-k8s:/macos/.wiki-k8s\" \\\n  --volume \"$HOME/workspace/fedwiki:/macos/fedwiki\" \\\n  --wait\n"
    },
    {
      "type": "paragraph",
      "id": "684bcc8af688159e",
      "text": "And what about starting the wiki in that cluster?"
    },
    {
      "type": "code",
      "id": "b647e62f6e811edf",
      "text": "kubectl apply -f \\\n  https://deploy.wiki.do/assets/wiki/wiki.yaml"
    },
    {
      "type": "paragraph",
      "id": "df4504813d67d1c1",
      "text": "Sigh. More errors. The containers deployed okay but the Ingress record complained."
    },
    {
      "type": "code",
      "id": "1421b58134a8ef70",
      "text": "no matches for kind \"Ingress\" in version \"networking.k8s.io/v1\""
    },
    {
      "type": "paragraph",
      "id": "d17b31db9aa949a8",
      "text": "Our search for that error message turned up a clue in an issue in kubernetes github [https://github.com/kubernetes/kubernetes/issues/90077#issuecomment-718778960 comment]. We cannot explain how we sift all the information in this issue to narrow in on this single comment. Mainly, we knew we were looking for version information related to Ingress."
    },
    {
      "type": "code",
      "id": "ada31492bda60ff2",
      "text": "networking.k8s.io/v1beta1 == 1.14 to 1.18\nnetworking.k8s.io/v1 = 1.19+"
    },
    {
      "type": "paragraph",
      "id": "3aa7138a3a7a55f2",
      "text": "Here we struggled a while to figure out which kubernetes version was installed by default with the latest k3d. After a time we gave up investigating and shifted again to just find a way to install a specific version. (Notice the new --image flag)"
    },
    {
      "type": "code",
      "id": "f2ee4fbaab89c92c",
      "text": "k3d cluster delete wiki\nk3d cluster create wiki \\\n  --k3s-server-arg --tls-san=\"127.0.0.1\" \\\n  --port 80:80@loadbalancer \\\n  --image rancher/k3s:v1.21.2-k3s1 \\\n  --volume \"$HOME/.wiki-k8s:/macos/.wiki-k8s\" \\\n  --volume \"$HOME/workspace/fedwiki:/macos/fedwiki\" \\\n  --volume \"$PWD/assets/wiki:/var/lib/rancher/k3s/server/manifests/wiki\" \\\n  --wait\n"
    },
    {
      "type": "paragraph",
      "id": "06d35d7c5cd223ab",
      "text": "And we try again to deploy wiki to the cluster."
    },
    {
      "type": "code",
      "id": "aa8433d33fa876a3",
      "text": "kubectl apply -f \\\n  https://deploy.wiki.do/assets/wiki/wiki.yaml\n"
    },
    {
      "type": "paragraph",
      "id": "8a745bb3e37c1df1",
      "text": "Sigh. At least it was a different error."
    },
    {
      "type": "code",
      "id": "e96d45a16c4e0092",
      "text": "unknown field \"serviceName\" in io.k8s.api.networking.v1.IngressBackend\n"
    },
    {
      "type": "paragraph",
      "id": "3bbff908ae1375dc",
      "text": "We find our next clue at Stackoverflow. [https://stackoverflow.com/a/64126069/1074208 stackoverflow]"
    },
    {
      "type": "paragraph",
      "id": "dee80154e7597347",
      "text": "We update our ingress configuration. A couple times."
    },
    {
      "type": "paragraph",
      "id": "eb2e46527bb006b8",
      "text": "[https://github.com/dobbs/deploy.wiki.do/commit/2d0f038386cd25a3f4389aff3b18de26adc3bab7 commit]"
    },
    {
      "type": "paragraph",
      "id": "d16afff08aab7538",
      "text": "Finally, success."
    },
    {
      "type": "pagefold",
      "id": "22686067d5b4554e",
      "text": "."
    },
    {
      "type": "paragraph",
      "id": "d8d316be2c3e2586",
      "text": "While composing this page we also learned how to see timestamps in our zsh history. Thanks [https://unix.stackexchange.com/a/103407/292465 stackexchange]"
    },
    {
      "type": "code",
      "id": "0527b2f3efd7ec1d",
      "text": "history -E\nhistory -i\n\\history -E\n\\history -i"
    },
    {
      "type": "paragraph",
      "id": "51bf976ba14f6e43",
      "text": "It was also helpful reviewing our browser history in Firefox to remember what error messages we searched for and where we found the useful answers."
    }
  ],
  "journal": [
    {
      "type": "create",
      "item": {
        "title": "Upgrade Interruption 2021-06",
        "story": []
      },
      "date": 1624552405891
    },
    {
      "item": {
        "type": "factory",
        "id": "960bbb2f00a23348"
      },
      "id": "960bbb2f00a23348",
      "type": "add",
      "date": 1624552428097
    },
    {
      "type": "edit",
      "id": "960bbb2f00a23348",
      "item": {
        "type": "paragraph",
        "id": "960bbb2f00a23348",
        "text": "Racing the Red Queen again. See [[Bit Rot and Red Queen Effect]]."
      },
      "date": 1624552496201
    },
    {
      "type": "edit",
      "id": "960bbb2f00a23348",
      "item": {
        "type": "paragraph",
        "id": "960bbb2f00a23348",
        "text": "Apple, like many others, pesters with red dots—little Red Queens to race again in Wonderland. Last night we stopped postponing Mac OS 11.4. This morning confirmed our reluctance. Unplanned work greeted us: local wiki was no longer working. To return to service we re-learn our local deploy and learn new corners of keeping up with The Internet. We offer these notes with many hopes: perhaps our future self can untangle a future knot, perhaps our collaborators can be spared a few extra minutes, perhaps future wiki admins can plan for a little slack in their schedule. Interruptions abound."
      },
      "date": 1624553047584
    },
    {
      "type": "add",
      "id": "c3086d5b1313e362",
      "item": {
        "type": "paragraph",
        "id": "c3086d5b1313e362",
        "text": "See [[Bit Rot and Red Queen Effect]]."
      },
      "after": "960bbb2f00a23348",
      "date": 1624553048420
    },
    {
      "type": "add",
      "id": "b73186404973dbd7",
      "item": {
        "type": "paragraph",
        "id": "b73186404973dbd7",
        "text": "See [[Tempo Interruptions]]"
      },
      "after": "c3086d5b1313e362",
      "date": 1624553062306
    },
    {
      "type": "add",
      "id": "e22dc4d84f5c3fdc",
      "item": {
        "type": "paragraph",
        "id": "e22dc4d84f5c3fdc",
        "text": "The first symptom appeared after a Restore Previous Session in Firefox. [http://localhost http://localhost] and [http://today.localhost http://today.localhost] won't open."
      },
      "after": "b73186404973dbd7",
      "date": 1624553364536
    },
    {
      "type": "add",
      "id": "76b9dd74807a4774",
      "item": {
        "type": "paragraph",
        "id": "76b9dd74807a4774",
        "text": "Is our wiki running?"
      },
      "after": "e22dc4d84f5c3fdc",
      "date": 1624553384844
    },
    {
      "type": "add",
      "id": "c52160e042761003",
      "item": {
        "type": "factory",
        "id": "c52160e042761003",
        "text": "kubectl get all"
      },
      "after": "76b9dd74807a4774",
      "date": 1624553395759
    },
    {
      "type": "edit",
      "id": "c52160e042761003",
      "item": {
        "type": "code",
        "id": "c52160e042761003",
        "text": "$ kubectl get all"
      },
      "date": 1624553401541
    },
    {
      "type": "edit",
      "id": "c52160e042761003",
      "item": {
        "type": "code",
        "id": "c52160e042761003",
        "text": "$ kubectl get all\nNAME                                   READY   STATUS    RESTARTS   AGE\npod/wiki-deployment-7c55db6fc7-r6q9w   1/1     Running   0          94m\n\nNAME                   TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE\nservice/kubernetes     ClusterIP   10.43.0.1      <none>        443/TCP   95m\nservice/wiki-service   ClusterIP   10.43.43.161   <none>        80/TCP    94m\n\nNAME                              READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/wiki-deployment   1/1     1            1           94m\n\nNAME                                         DESIRED   CURRENT   READY   AGE\nreplicaset.apps/wiki-deployment-7c55db6fc7   1         1         1       94m\n"
      },
      "date": 1624553435597
    },
    {
      "type": "edit",
      "id": "c52160e042761003",
      "item": {
        "type": "code",
        "id": "c52160e042761003",
        "text": "kubectl get all"
      },
      "date": 1624553449062
    },
    {
      "item": {
        "type": "factory",
        "id": "bb0b694c9d000338"
      },
      "id": "bb0b694c9d000338",
      "type": "add",
      "after": "c52160e042761003",
      "date": 1624553452565
    },
    {
      "type": "edit",
      "id": "bb0b694c9d000338",
      "item": {
        "type": "paragraph",
        "id": "bb0b694c9d000338",
        "text": "We see pod/wiki-deployment and service/wiki-service which are our usual confirmations."
      },
      "date": 1624553478629
    },
    {
      "type": "edit",
      "id": "bb0b694c9d000338",
      "item": {
        "type": "paragraph",
        "id": "bb0b694c9d000338",
        "text": "We see deployment/wiki-deployment and service/wiki-service which are our usual confirmations."
      },
      "date": 1624553508467
    },
    {
      "type": "edit",
      "id": "bb0b694c9d000338",
      "item": {
        "type": "paragraph",
        "id": "bb0b694c9d000338",
        "text": "We see deployment.apps/wiki-deployment and service/wiki-service which are our usual confirmations."
      },
      "date": 1624553521754
    },
    {
      "type": "add",
      "id": "e578cb7cf4d2af0a",
      "item": {
        "type": "paragraph",
        "id": "e578cb7cf4d2af0a",
        "text": "Are we getting logs?"
      },
      "after": "bb0b694c9d000338",
      "date": 1624553540857
    },
    {
      "type": "add",
      "id": "eb13233e57692c1a",
      "item": {
        "type": "factory",
        "id": "eb13233e57692c1a",
        "text": "kubectl logs deployment/wiki-deployment"
      },
      "after": "e578cb7cf4d2af0a",
      "date": 1624553556705
    },
    {
      "item": {
        "type": "factory",
        "id": "3417f87e5876dfe9"
      },
      "id": "3417f87e5876dfe9",
      "type": "add",
      "after": "eb13233e57692c1a",
      "date": 1624553573002
    },
    {
      "type": "edit",
      "id": "3417f87e5876dfe9",
      "item": {
        "type": "factory",
        "id": "3417f87e5876dfe9",
        "text": "Wiki starting in Farm mode, navigate to a specific server to start it.\n"
      },
      "date": 1624553577378
    },
    {
      "type": "edit",
      "id": "3417f87e5876dfe9",
      "item": {
        "type": "code",
        "id": "3417f87e5876dfe9",
        "text": "// kubernetes replies...\nWiki starting in Farm mode, navigate to a specific server to start it."
      },
      "date": 1624553603872
    },
    {
      "item": {
        "type": "factory",
        "id": "8dce39694eaf41dc"
      },
      "id": "8dce39694eaf41dc",
      "type": "add",
      "after": "3417f87e5876dfe9",
      "date": 1624553608210
    },
    {
      "type": "edit",
      "id": "8dce39694eaf41dc",
      "item": {
        "type": "paragraph",
        "id": "8dce39694eaf41dc",
        "text": "That suggests the requests from Firefox are not making it all the way into our container."
      },
      "date": 1624553629655
    },
    {
      "type": "edit",
      "id": "8dce39694eaf41dc",
      "item": {
        "type": "paragraph",
        "id": "8dce39694eaf41dc",
        "text": "That suggests the requests from Firefox are not making it all the way into our container. The wiki farm has started, but no requests have landed yet."
      },
      "date": 1624554605446
    },
    {
      "item": {
        "type": "factory",
        "id": "22686067d5b4554e"
      },
      "id": "22686067d5b4554e",
      "type": "add",
      "after": "8dce39694eaf41dc",
      "date": 1624555734244
    },
    {
      "type": "edit",
      "id": "22686067d5b4554e",
      "item": {
        "type": "pagefold",
        "id": "22686067d5b4554e",
        "text": "."
      },
      "date": 1624555737388
    },
    {
      "item": {
        "type": "factory",
        "id": "d8d316be2c3e2586"
      },
      "id": "d8d316be2c3e2586",
      "type": "add",
      "after": "22686067d5b4554e",
      "date": 1624555738752
    },
    {
      "type": "edit",
      "id": "d8d316be2c3e2586",
      "item": {
        "type": "paragraph",
        "id": "d8d316be2c3e2586",
        "text": "While composing this page we also learned how to see timestamps in our zsh history. Thanks [https://unix.stackexchange.com/a/103407/292465 stackexchange]"
      },
      "date": 1624556092866
    },
    {
      "item": {
        "type": "factory",
        "id": "0527b2f3efd7ec1d"
      },
      "id": "0527b2f3efd7ec1d",
      "type": "add",
      "after": "d8d316be2c3e2586",
      "date": 1624556095917
    },
    {
      "type": "edit",
      "id": "0527b2f3efd7ec1d",
      "item": {
        "type": "code",
        "id": "0527b2f3efd7ec1d",
        "text": "history -E\nhistory -i\n\\history -E\n\\history -i"
      },
      "date": 1624556122801
    },
    {
      "type": "add",
      "id": "15e237b90569a711",
      "item": {
        "type": "paragraph",
        "id": "15e237b90569a711",
        "text": "We dig deeper into our memory... which containers run kubernetes again?"
      },
      "after": "8dce39694eaf41dc",
      "date": 1624556373394
    },
    {
      "type": "add",
      "id": "56991842404f0f1d",
      "item": {
        "type": "factory",
        "id": "56991842404f0f1d",
        "text": "docker "
      },
      "after": "15e237b90569a711",
      "date": 1624556375454
    },
    {
      "type": "edit",
      "id": "56991842404f0f1d",
      "item": {
        "type": "code",
        "id": "56991842404f0f1d",
        "text": "docker ps --format '{{.Names}}'"
      },
      "date": 1624556395127
    },
    {
      "type": "edit",
      "id": "56991842404f0f1d",
      "item": {
        "type": "code",
        "id": "56991842404f0f1d",
        "text": "$ docker ps --format '{{.Names}}'\nk3d-wiki-serverlb\nk3d-wiki-server-0"
      },
      "date": 1624556423291
    },
    {
      "type": "add",
      "id": "1c6baf379ff388e7",
      "item": {
        "type": "paragraph",
        "id": "1c6baf379ff388e7",
        "text": "Hmmm serverlb rings a bell. "
      },
      "after": "15e237b90569a711",
      "date": 1624556569905
    },
    {
      "type": "edit",
      "id": "56991842404f0f1d",
      "item": {
        "type": "code",
        "id": "56991842404f0f1d",
        "text": "$ docker ps --format '{{.Names}} {{.Ports}}'\nk3d-wiki-serverlb 0.0.0.0:80->80/tcp, :::80->80/tcp, 0.0.0.0:51501->6443/tcp\nk3d-wiki-server-0"
      },
      "date": 1624556622688
    },
    {
      "id": "1c6baf379ff388e7",
      "type": "move",
      "order": [
        "960bbb2f00a23348",
        "c3086d5b1313e362",
        "b73186404973dbd7",
        "e22dc4d84f5c3fdc",
        "76b9dd74807a4774",
        "c52160e042761003",
        "bb0b694c9d000338",
        "e578cb7cf4d2af0a",
        "eb13233e57692c1a",
        "3417f87e5876dfe9",
        "8dce39694eaf41dc",
        "15e237b90569a711",
        "56991842404f0f1d",
        "1c6baf379ff388e7",
        "22686067d5b4554e",
        "d8d316be2c3e2586",
        "0527b2f3efd7ec1d"
      ],
      "date": 1624556628944
    },
    {
      "type": "edit",
      "id": "1c6baf379ff388e7",
      "item": {
        "type": "paragraph",
        "id": "1c6baf379ff388e7",
        "text": "k3d-wiki-serverlb is listening on port 80."
      },
      "date": 1624556669880
    },
    {
      "type": "add",
      "id": "d5c346599fa3b833",
      "item": {
        "type": "paragraph",
        "id": "d5c346599fa3b833",
        "text": "docker logs --tail=200 k3d-wiki-serverlb  "
      },
      "after": "1c6baf379ff388e7",
      "date": 1624556691621
    },
    {
      "type": "edit",
      "id": "d5c346599fa3b833",
      "item": {
        "type": "code",
        "id": "d5c346599fa3b833",
        "text": "docker logs --tail=200 k3d-wiki-serverlb"
      },
      "date": 1624556749377
    },
    {
      "item": {
        "type": "factory",
        "id": "a3091c5ad10216ef"
      },
      "id": "a3091c5ad10216ef",
      "type": "add",
      "after": "0527b2f3efd7ec1d",
      "date": 1624556754199
    },
    {
      "id": "a3091c5ad10216ef",
      "type": "move",
      "order": [
        "960bbb2f00a23348",
        "c3086d5b1313e362",
        "b73186404973dbd7",
        "e22dc4d84f5c3fdc",
        "76b9dd74807a4774",
        "c52160e042761003",
        "bb0b694c9d000338",
        "e578cb7cf4d2af0a",
        "eb13233e57692c1a",
        "3417f87e5876dfe9",
        "8dce39694eaf41dc",
        "15e237b90569a711",
        "56991842404f0f1d",
        "1c6baf379ff388e7",
        "d5c346599fa3b833",
        "a3091c5ad10216ef",
        "22686067d5b4554e",
        "d8d316be2c3e2586",
        "0527b2f3efd7ec1d"
      ],
      "date": 1624556756571
    },
    {
      "type": "edit",
      "id": "a3091c5ad10216ef",
      "item": {
        "type": "paragraph",
        "id": "a3091c5ad10216ef",
        "text": "We recall that these logs showed problems finding the upstream server—it is all fixed at the time of this writing, so we no longer have a copy of the logs to show you, Dear Reader."
      },
      "date": 1624556855282
    },
    {
      "type": "add",
      "id": "2e0b0ec0b463c2c2",
      "item": {
        "type": "paragraph",
        "id": "2e0b0ec0b463c2c2",
        "text": "Docker was seeing the traffic from Firefox, but failing to connect through the docker and k3d machinery into the wiki container."
      },
      "after": "a3091c5ad10216ef",
      "date": 1624556869968
    },
    {
      "type": "add",
      "id": "34ded1f175334cb4",
      "item": {
        "type": "paragraph",
        "id": "34ded1f175334cb4",
        "text": "We shifted from investigation and started with speculative interventions."
      },
      "after": "2e0b0ec0b463c2c2",
      "date": 1624556914743
    },
    {
      "type": "add",
      "id": "7f89578509210edc",
      "item": {
        "type": "paragraph",
        "id": "7f89578509210edc",
        "text": "What version of k3d are we running?"
      },
      "after": "34ded1f175334cb4",
      "date": 1624556922556
    },
    {
      "type": "add",
      "id": "a9a2be9f3abfbe03",
      "item": {
        "type": "paragraph",
        "id": "a9a2be9f3abfbe03",
        "text": "k3d --version  "
      },
      "after": "7f89578509210edc",
      "date": 1624556929383
    },
    {
      "type": "add",
      "id": "e58ff52de1ce01ea",
      "item": {
        "type": "paragraph",
        "id": "e58ff52de1ce01ea",
        "text": "Searching the Net revealed k3d is now at version 4. So we upgrade."
      },
      "after": "a9a2be9f3abfbe03",
      "date": 1624556981366
    },
    {
      "type": "add",
      "id": "2a74cae392424228",
      "item": {
        "type": "paragraph",
        "id": "2a74cae392424228",
        "text": "k3d cluster delete wiki"
      },
      "after": "e58ff52de1ce01ea",
      "date": 1624556999171
    },
    {
      "type": "add",
      "id": "b6b859df3d70578e",
      "item": {
        "type": "paragraph",
        "id": "b6b859df3d70578e",
        "text": "brew upgrade k3d"
      },
      "after": "2a74cae392424228",
      "date": 1624557011157
    },
    {
      "type": "edit",
      "id": "a9a2be9f3abfbe03",
      "item": {
        "type": "code",
        "id": "a9a2be9f3abfbe03",
        "text": "k3d --version"
      },
      "date": 1624557046621
    },
    {
      "type": "edit",
      "id": "e58ff52de1ce01ea",
      "item": {
        "type": "paragraph",
        "id": "e58ff52de1ce01ea",
        "text": "We were on version 3.x. Current k3d is now 4.x. So we upgrade."
      },
      "date": 1624557092525
    },
    {
      "type": "add",
      "id": "831901168a278b20",
      "item": {
        "type": "paragraph",
        "id": "831901168a278b20",
        "text": "And we re-run our cluster creation script."
      },
      "after": "b6b859df3d70578e",
      "date": 1624557128844
    },
    {
      "type": "remove",
      "id": "b6b859df3d70578e",
      "date": 1624557133004
    },
    {
      "type": "edit",
      "id": "2a74cae392424228",
      "item": {
        "type": "factory",
        "id": "2a74cae392424228",
        "text": "k3d cluster delete wikibrew upgrade k3d"
      },
      "date": 1624557134895
    },
    {
      "type": "edit",
      "id": "2a74cae392424228",
      "item": {
        "type": "code",
        "id": "2a74cae392424228",
        "text": "k3d cluster delete wiki\nbrew upgrade k3d"
      },
      "date": 1624557144062
    },
    {
      "type": "add",
      "id": "bf3d9356326f36cf",
      "item": {
        "type": "paragraph",
        "id": "bf3d9356326f36cf",
        "text": "What follows is a play-by-play of our troubleshooting."
      },
      "after": "b73186404973dbd7",
      "date": 1624557255954
    },
    {
      "type": "edit",
      "id": "831901168a278b20",
      "item": {
        "type": "paragraph",
        "id": "831901168a278b20",
        "text": "And we re-run our cluster creation script. How did that work again?"
      },
      "date": 1624557379397
    },
    {
      "type": "add",
      "id": "652cd33dc158a649",
      "item": {
        "type": "paragraph",
        "id": "652cd33dc158a649",
        "text": "Is it in our dotfiles? Or in that unfinished github repo?"
      },
      "after": "831901168a278b20",
      "date": 1624557404265
    },
    {
      "type": "add",
      "id": "170eff2ec46e84fd",
      "item": {
        "type": "paragraph",
        "id": "170eff2ec46e84fd",
        "text": "[https://github.com/dobbs/deploy.wiki.do/blob/2a387bc41d4b2efaee96c946febe715875b434db/assets/bin/install-k8s-wiki.sh#L7-L13 repo]"
      },
      "after": "652cd33dc158a649",
      "date": 1624557420780
    },
    {
      "type": "edit",
      "id": "170eff2ec46e84fd",
      "item": {
        "type": "paragraph",
        "id": "170eff2ec46e84fd",
        "text": "[https://github.com/dobbs/deploy.wiki.do/blob/2a387bc41d4b2efaee96c946febe715875b434db/assets/bin/install-k8s-wiki.sh#L7-L13 repo] [https://github.com/dobbs/dotfiles/blob/963b8884256309dc8ac6d0efc2bf8d630557ab89/install.d/install-k3d-cluster#L6-L12 dotfiles]"
      },
      "date": 1624557476868
    },
    {
      "type": "edit",
      "id": "170eff2ec46e84fd",
      "item": {
        "type": "paragraph",
        "id": "170eff2ec46e84fd",
        "text": "Turns out both: [https://github.com/dobbs/deploy.wiki.do/blob/2a387bc41d4b2efaee96c946febe715875b434db/assets/bin/install-k8s-wiki.sh#L7-L13 repo] [https://github.com/dobbs/dotfiles/blob/963b8884256309dc8ac6d0efc2bf8d630557ab89/install.d/install-k3d-cluster#L6-L12 dotfiles]"
      },
      "date": 1624557486105
    },
    {
      "type": "add",
      "id": "465ab94edb562ff9",
      "item": {
        "type": "paragraph",
        "id": "465ab94edb562ff9",
        "text": "k3d cluster create wiki \\\n  --k3s-server-arg --tls-san=\"127.0.0.1\" \\\n  --port 80:80@loadbalancer \\\n  --volume \"$HOME/.wiki-k8s:/macos/.wiki-k8s\" \\\n  --volume \"$HOME/workspace/fedwiki:/macos/fedwiki\" \\\n  --wait"
      },
      "after": "170eff2ec46e84fd",
      "date": 1624557546670
    },
    {
      "type": "add",
      "id": "684bcc8af688159e",
      "item": {
        "type": "paragraph",
        "id": "684bcc8af688159e",
        "text": "And what about starting the wiki in that cluster?"
      },
      "after": "465ab94edb562ff9",
      "date": 1624557566007
    },
    {
      "type": "edit",
      "id": "465ab94edb562ff9",
      "item": {
        "type": "code",
        "id": "465ab94edb562ff9",
        "text": "k3d cluster create wiki \\\n  --k3s-server-arg --tls-san=\"127.0.0.1\" \\\n  --port 80:80@loadbalancer \\\n  --volume \"$HOME/.wiki-k8s:/macos/.wiki-k8s\" \\\n  --volume \"$HOME/workspace/fedwiki:/macos/fedwiki\" \\\n  --wait\n"
      },
      "date": 1624557572721
    },
    {
      "type": "add",
      "id": "b647e62f6e811edf",
      "item": {
        "type": "paragraph",
        "id": "b647e62f6e811edf",
        "text": "kubectl apply -f https://deploy.wiki.do/assets/wiki/wiki.yaml"
      },
      "after": "684bcc8af688159e",
      "date": 1624557612391
    },
    {
      "type": "edit",
      "id": "b647e62f6e811edf",
      "item": {
        "type": "paragraph",
        "id": "b647e62f6e811edf",
        "text": "kubectl apply -f https://deploy.wiki.do/assets/wiki/wiki.yaml  "
      },
      "date": 1624557618979
    },
    {
      "type": "add",
      "id": "df4504813d67d1c1",
      "item": {
        "type": "paragraph",
        "id": "df4504813d67d1c1",
        "text": "Sigh. More errors. The containers deployed okay but the Ingress record complained."
      },
      "after": "b647e62f6e811edf",
      "date": 1624557654170
    },
    {
      "type": "edit",
      "id": "b647e62f6e811edf",
      "item": {
        "type": "code",
        "id": "b647e62f6e811edf",
        "text": "kubectl apply -f https://deploy.wiki.do/assets/wiki/wiki.yaml"
      },
      "date": 1624557663890
    },
    {
      "type": "edit",
      "id": "b647e62f6e811edf",
      "item": {
        "type": "code",
        "id": "b647e62f6e811edf",
        "text": "kubectl apply -f \\\n  https://deploy.wiki.do/assets/wiki/wiki.yaml"
      },
      "date": 1624557672263
    },
    {
      "type": "edit",
      "id": "170eff2ec46e84fd",
      "item": {
        "type": "paragraph",
        "id": "170eff2ec46e84fd",
        "text": "Turns out both: [https://github.com/dobbs/dotfiles/blob/963b8884256309dc8ac6d0efc2bf8d630557ab89/install.d/install-k3d-cluster#L6-L12 dotfiles]  [https://github.com/dobbs/deploy.wiki.do/blob/2a387bc41d4b2efaee96c946febe715875b434db/assets/bin/install-k8s-wiki.sh#L7-L13 repo]"
      },
      "date": 1624557711503
    },
    {
      "type": "add",
      "id": "1421b58134a8ef70",
      "item": {
        "type": "paragraph",
        "id": "1421b58134a8ef70",
        "text": "no matches for kind \"Ingress\" in version \"networking.k8s.io/v1\""
      },
      "after": "df4504813d67d1c1",
      "date": 1624557890771
    },
    {
      "type": "add",
      "id": "d17b31db9aa949a8",
      "item": {
        "type": "paragraph",
        "id": "d17b31db9aa949a8",
        "text": "Our search for that error message turned up a clue in an issue in kubernetes github [https://github.com/kubernetes/kubernetes/issues/90077#issuecomment-718778960 comment]"
      },
      "after": "1421b58134a8ef70",
      "date": 1624558001845
    },
    {
      "type": "add",
      "id": "ada31492bda60ff2",
      "item": {
        "type": "paragraph",
        "id": "ada31492bda60ff2",
        "text": "networking.k8s.io/v1beta1 == 1.14 to 1.18\n\nnetworking.k8s.io/v1 = 1.19+  "
      },
      "after": "d17b31db9aa949a8",
      "date": 1624558033479
    },
    {
      "type": "edit",
      "id": "1421b58134a8ef70",
      "item": {
        "type": "factory",
        "id": "1421b58134a8ef70",
        "text": "no matches for kind \"Ingress\" in version \"networking.k8s.io/v1\" "
      },
      "date": 1624558039260
    },
    {
      "type": "edit",
      "id": "1421b58134a8ef70",
      "item": {
        "type": "code",
        "id": "1421b58134a8ef70",
        "text": "no matches for kind \"Ingress\" in version \"networking.k8s.io/v1\"  "
      },
      "date": 1624558044187
    },
    {
      "type": "edit",
      "id": "1421b58134a8ef70",
      "item": {
        "type": "code",
        "id": "1421b58134a8ef70",
        "text": "no matches for kind \"Ingress\" in version \"networking.k8s.io/v1\""
      },
      "date": 1624558048452
    },
    {
      "type": "edit",
      "id": "ada31492bda60ff2",
      "item": {
        "type": "code",
        "id": "ada31492bda60ff2",
        "text": "networking.k8s.io/v1beta1 == 1.14 to 1.18\nnetworking.k8s.io/v1 = 1.19+"
      },
      "date": 1624558058323
    },
    {
      "item": {
        "type": "factory",
        "id": "3aa7138a3a7a55f2"
      },
      "id": "3aa7138a3a7a55f2",
      "type": "add",
      "after": "0527b2f3efd7ec1d",
      "date": 1624558079365
    },
    {
      "id": "3aa7138a3a7a55f2",
      "type": "move",
      "order": [
        "960bbb2f00a23348",
        "c3086d5b1313e362",
        "b73186404973dbd7",
        "bf3d9356326f36cf",
        "e22dc4d84f5c3fdc",
        "76b9dd74807a4774",
        "c52160e042761003",
        "bb0b694c9d000338",
        "e578cb7cf4d2af0a",
        "eb13233e57692c1a",
        "3417f87e5876dfe9",
        "8dce39694eaf41dc",
        "15e237b90569a711",
        "56991842404f0f1d",
        "1c6baf379ff388e7",
        "d5c346599fa3b833",
        "a3091c5ad10216ef",
        "2e0b0ec0b463c2c2",
        "34ded1f175334cb4",
        "7f89578509210edc",
        "a9a2be9f3abfbe03",
        "e58ff52de1ce01ea",
        "2a74cae392424228",
        "831901168a278b20",
        "652cd33dc158a649",
        "170eff2ec46e84fd",
        "465ab94edb562ff9",
        "684bcc8af688159e",
        "b647e62f6e811edf",
        "df4504813d67d1c1",
        "1421b58134a8ef70",
        "d17b31db9aa949a8",
        "ada31492bda60ff2",
        "3aa7138a3a7a55f2",
        "22686067d5b4554e",
        "d8d316be2c3e2586",
        "0527b2f3efd7ec1d"
      ],
      "date": 1624558081539
    },
    {
      "type": "edit",
      "id": "3aa7138a3a7a55f2",
      "item": {
        "type": "paragraph",
        "id": "3aa7138a3a7a55f2",
        "text": "H"
      },
      "date": 1624558083016
    },
    {
      "type": "edit",
      "id": "3aa7138a3a7a55f2",
      "item": {
        "type": "paragraph",
        "id": "3aa7138a3a7a55f2",
        "text": "Here we struggled a while to figure out which kubernetes version was installed by default with the latest k3d. After a time we just found a way to install a cluster with a specific version."
      },
      "date": 1624558167511
    },
    {
      "type": "add",
      "id": "f2ee4fbaab89c92c",
      "item": {
        "type": "paragraph",
        "id": "f2ee4fbaab89c92c",
        "text": "k3d cluster delete wiki\n"
      },
      "after": "3aa7138a3a7a55f2",
      "date": 1624558180897
    },
    {
      "type": "edit",
      "id": "f2ee4fbaab89c92c",
      "item": {
        "type": "paragraph",
        "id": "f2ee4fbaab89c92c",
        "text": "k3d cluster delete wiki\nk3d cluster create wiki \\\n  --k3s-server-arg --tls-san=\"127.0.0.1\" \\\n  --port 80:80@loadbalancer \\\n  --image rancher/k3s:v1.21.2-k3s1 \\\n  --volume \"$HOME/.wiki-k8s:/macos/.wiki-k8s\" \\\n  --volume \"$HOME/workspace/fedwiki:/macos/fedwiki\" \\\n  --volume \"$PWD/assets/wiki:/var/lib/rancher/k3s/server/manifests/wiki\" \\\n  --wait"
      },
      "date": 1624558262735
    },
    {
      "type": "add",
      "id": "06d35d7c5cd223ab",
      "item": {
        "type": "paragraph",
        "id": "06d35d7c5cd223ab",
        "text": "And we try again to deploy wiki to the cluster."
      },
      "after": "f2ee4fbaab89c92c",
      "date": 1624558296548
    },
    {
      "type": "edit",
      "id": "f2ee4fbaab89c92c",
      "item": {
        "type": "code",
        "id": "f2ee4fbaab89c92c",
        "text": "k3d cluster delete wiki\nk3d cluster create wiki \\\n  --k3s-server-arg --tls-san=\"127.0.0.1\" \\\n  --port 80:80@loadbalancer \\\n  --image rancher/k3s:v1.21.2-k3s1 \\\n  --volume \"$HOME/.wiki-k8s:/macos/.wiki-k8s\" \\\n  --volume \"$HOME/workspace/fedwiki:/macos/fedwiki\" \\\n  --volume \"$PWD/assets/wiki:/var/lib/rancher/k3s/server/manifests/wiki\" \\\n  --wait\n"
      },
      "date": 1624558302387
    },
    {
      "type": "add",
      "id": "aa8433d33fa876a3",
      "item": {
        "type": "paragraph",
        "id": "aa8433d33fa876a3",
        "text": "kubectl apply -f \\\n  https://deploy.wiki.do/assets/wiki/wiki.yaml"
      },
      "after": "06d35d7c5cd223ab",
      "date": 1624558317470
    },
    {
      "type": "add",
      "id": "8a745bb3e37c1df1",
      "item": {
        "type": "paragraph",
        "id": "8a745bb3e37c1df1",
        "text": "Sigh. At least its a different error."
      },
      "after": "aa8433d33fa876a3",
      "date": 1624558326168
    },
    {
      "type": "add",
      "id": "e96d45a16c4e0092",
      "item": {
        "type": "paragraph",
        "id": "e96d45a16c4e0092",
        "text": "unknown field \"serviceName\" in io.k8s.api.networking.v1.IngressBackend"
      },
      "after": "8a745bb3e37c1df1",
      "date": 1624558397309
    },
    {
      "type": "edit",
      "id": "8a745bb3e37c1df1",
      "item": {
        "type": "paragraph",
        "id": "8a745bb3e37c1df1",
        "text": "Sigh. At least it was a different error."
      },
      "date": 1624558406380
    },
    {
      "type": "add",
      "id": "3bbff908ae1375dc",
      "item": {
        "type": "paragraph",
        "id": "3bbff908ae1375dc",
        "text": "We find our next clue at Stackoverflow.[https://stackoverflow.com/a/64126069/1074208 stackoverflow]"
      },
      "after": "e96d45a16c4e0092",
      "date": 1624558524140
    },
    {
      "type": "edit",
      "id": "3bbff908ae1375dc",
      "item": {
        "type": "paragraph",
        "id": "3bbff908ae1375dc",
        "text": "We find our next clue at Stackoverflow. [https://stackoverflow.com/a/64126069/1074208 stackoverflow]"
      },
      "date": 1624558529103
    },
    {
      "type": "add",
      "id": "dee80154e7597347",
      "item": {
        "type": "paragraph",
        "id": "dee80154e7597347",
        "text": "We update our ingress configuration. A couple times."
      },
      "after": "3bbff908ae1375dc",
      "date": 1624558562161
    },
    {
      "type": "edit",
      "id": "aa8433d33fa876a3",
      "item": {
        "type": "code",
        "id": "aa8433d33fa876a3",
        "text": "kubectl apply -f \\\n  https://deploy.wiki.do/assets/wiki/wiki.yaml\n"
      },
      "date": 1624558572183
    },
    {
      "type": "edit",
      "id": "e96d45a16c4e0092",
      "item": {
        "type": "code",
        "id": "e96d45a16c4e0092",
        "text": "\nunknown field \"serviceName\" in io.k8s.api.networking.v1.IngressBackend\n"
      },
      "date": 1624558583104
    },
    {
      "type": "edit",
      "id": "e96d45a16c4e0092",
      "item": {
        "type": "code",
        "id": "e96d45a16c4e0092",
        "text": "unknown field \"serviceName\" in io.k8s.api.networking.v1.IngressBackend\n"
      },
      "date": 1624558586897
    },
    {
      "type": "add",
      "id": "eb2e46527bb006b8",
      "item": {
        "type": "paragraph",
        "id": "eb2e46527bb006b8",
        "text": "[https://github.com/dobbs/deploy.wiki.do/commit/2d0f038386cd25a3f4389aff3b18de26adc3bab7 commit]"
      },
      "after": "dee80154e7597347",
      "date": 1624558651266
    },
    {
      "type": "add",
      "id": "d16afff08aab7538",
      "item": {
        "type": "paragraph",
        "id": "d16afff08aab7538",
        "text": "Finally, success."
      },
      "after": "eb2e46527bb006b8",
      "date": 1624558709164
    },
    {
      "type": "add",
      "id": "9a9e9e3b0f43c35d",
      "item": {
        "type": "paragraph",
        "id": "9a9e9e3b0f43c35d",
        "text": "At the time of our troubleshooting, we only vaguely remembered exactly how all the parts play together. While composing this page, we have found a diagram."
      },
      "after": "2e0b0ec0b463c2c2",
      "date": 1624559006647
    },
    {
      "type": "add",
      "id": "857474b898d18e12",
      "item": {
        "type": "paragraph",
        "id": "857474b898d18e12",
        "text": "See [[Local Kubernetes Wiki]]"
      },
      "after": "9a9e9e3b0f43c35d",
      "date": 1624559024697
    },
    {
      "type": "edit",
      "id": "34ded1f175334cb4",
      "item": {
        "type": "paragraph",
        "id": "34ded1f175334cb4",
        "text": "Back to the story, we shifted at this point from investigation and started with speculative interventions."
      },
      "date": 1624559114784
    },
    {
      "type": "edit",
      "id": "9a9e9e3b0f43c35d",
      "item": {
        "type": "paragraph",
        "id": "9a9e9e3b0f43c35d",
        "text": "At the time of our troubleshooting, we only vaguely remembered exactly how all the parts play together. While composing this page, we have found a diagram which has some of the parts."
      },
      "date": 1624559152784
    },
    {
      "type": "remove",
      "id": "857474b898d18e12",
      "date": 1624559160488
    },
    {
      "type": "edit",
      "id": "9a9e9e3b0f43c35d",
      "item": {
        "type": "paragraph",
        "id": "9a9e9e3b0f43c35d",
        "text": "At the time of our troubleshooting, we only vaguely remembered exactly how all the parts play together. While composing this page, we have found a diagram which has some of the parts. See [[Local Kubernetes Wiki]]."
      },
      "date": 1624559161673
    },
    {
      "type": "edit",
      "id": "e58ff52de1ce01ea",
      "item": {
        "type": "paragraph",
        "id": "e58ff52de1ce01ea",
        "text": "We were on version 3.x. Current k3d is now 4.x. So we upgrade. There was a moment not documented in this story where we also did a bit of investigation to confirm that we did use homebrew to install k3d."
      },
      "date": 1624559223715
    },
    {
      "type": "edit",
      "id": "831901168a278b20",
      "item": {
        "type": "paragraph",
        "id": "831901168a278b20",
        "text": "How did we create the local k8s cluster, originally?"
      },
      "date": 1624559254960
    },
    {
      "type": "edit",
      "id": "d17b31db9aa949a8",
      "item": {
        "type": "paragraph",
        "id": "d17b31db9aa949a8",
        "text": "Our search for that error message turned up a clue in an issue in kubernetes github [https://github.com/kubernetes/kubernetes/issues/90077#issuecomment-718778960 comment]. We cannot explain how we sift all the information in this issue to narrow in on this single comment. Mainly, we knew we were looking for version information related to Ingress."
      },
      "date": 1624559351860
    },
    {
      "type": "edit",
      "id": "3aa7138a3a7a55f2",
      "item": {
        "type": "paragraph",
        "id": "3aa7138a3a7a55f2",
        "text": "Here we struggled a while to figure out which kubernetes version was installed by default with the latest k3d. After a time we gave up investigating and shifted again to just find a way to install a specific version."
      },
      "date": 1624559381539
    },
    {
      "type": "edit",
      "id": "3aa7138a3a7a55f2",
      "item": {
        "type": "paragraph",
        "id": "3aa7138a3a7a55f2",
        "text": "Here we struggled a while to figure out which kubernetes version was installed by default with the latest k3d. After a time we gave up investigating and shifted again to just find a way to install a specific version. (Notice the new --image flag)"
      },
      "date": 1624559396652
    },
    {
      "item": {
        "type": "factory",
        "id": "51bf976ba14f6e43"
      },
      "id": "51bf976ba14f6e43",
      "type": "add",
      "after": "0527b2f3efd7ec1d",
      "date": 1624559444619
    },
    {
      "type": "edit",
      "id": "51bf976ba14f6e43",
      "item": {
        "type": "paragraph",
        "id": "51bf976ba14f6e43",
        "text": "It was also helpful reviewing our browser history in Firefox to remember what error messages we searched for and where we found the useful answers."
      },
      "date": 1624559474070
    },
    {
      "type": "add",
      "id": "b0543da838848298",
      "item": {
        "type": "factory",
        "id": "b0543da838848298",
        "text": "digraph {}"
      },
      "after": "b73186404973dbd7",
      "date": 1624559559827
    },
    {
      "type": "edit",
      "id": "b0543da838848298",
      "item": {
        "type": "graphviz",
        "id": "b0543da838848298",
        "text": "digraph {\n  rankdir=LR\n\n\"Upgrade\\nMacOS\"\n-> \"Upgrade k3d\\nto 4.x\"\n-> \"Upgrade k8s\\nto 1.21\"\n-> \"Update ingress\\nconfig\"\n-> \"Write a\\nwiki page\"\n}"
      },
      "date": 1624559677678
    },
    {
      "type": "edit",
      "id": "b0543da838848298",
      "item": {
        "type": "graphviz",
        "id": "b0543da838848298",
        "text": "digraph {\n  rankdir=LR\n  node [shape=box style=\"rounded,filled\"]\n\n\"Upgrade\\nMacOS\"\n-> \"Upgrade k3d\\nto 4.x\"\n-> \"Upgrade k8s\\nto 1.21\"\n-> \"Update ingress\\nconfig\"\n-> \"Write a\\nwiki page\"\n}",
        "dot": "digraph {\n  rankdir=LR\n\n\"Upgrade\\nMacOS\"\n-> \"Upgrade k3d\\nto 4.x\"\n-> \"Upgrade k8s\\nto 1.21\"\n-> \"Update ingress\\nconfig\"\n-> \"Write a\\nwiki page\"\n}",
        "svg": "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.44.0 (20200518.1210)\n -->\n<!-- Pages: 1 -->\n<svg width=\"732pt\" height=\"67pt\"\n viewBox=\"0.00 0.00 732.44 66.83\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 62.83)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-62.83 728.44,-62.83 728.44,4 -4,4\"/>\n<!-- Upgrade\\nMacOS -->\n<g id=\"node1\" class=\"node\">\n<title>Upgrade\\nMacOS</title>\n<ellipse fill=\"none\" stroke=\"black\" cx=\"45.39\" cy=\"-29.42\" rx=\"45.29\" ry=\"29.33\"/>\n<text text-anchor=\"middle\" x=\"45.39\" y=\"-33.62\" font-family=\"Times,serif\" font-size=\"14.00\">Upgrade</text>\n<text text-anchor=\"middle\" x=\"45.39\" y=\"-16.82\" font-family=\"Times,serif\" font-size=\"14.00\">MacOS</text>\n</g>\n<!-- Upgrade k3d\\nto 4.x -->\n<g id=\"node2\" class=\"node\">\n<title>Upgrade k3d\\nto 4.x</title>\n<ellipse fill=\"none\" stroke=\"black\" cx=\"189.51\" cy=\"-29.42\" rx=\"62.94\" ry=\"29.33\"/>\n<text text-anchor=\"middle\" x=\"189.51\" y=\"-33.62\" font-family=\"Times,serif\" font-size=\"14.00\">Upgrade k3d</text>\n<text text-anchor=\"middle\" x=\"189.51\" y=\"-16.82\" font-family=\"Times,serif\" font-size=\"14.00\">to 4.x</text>\n</g>\n<!-- Upgrade\\nMacOS&#45;&gt;Upgrade k3d\\nto 4.x -->\n<g id=\"edge1\" class=\"edge\">\n<title>Upgrade\\nMacOS&#45;&gt;Upgrade k3d\\nto 4.x</title>\n<path fill=\"none\" stroke=\"black\" d=\"M90.97,-29.42C99.1,-29.42 107.77,-29.42 116.47,-29.42\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"116.65,-32.92 126.65,-29.42 116.65,-25.92 116.65,-32.92\"/>\n</g>\n<!-- Upgrade k8s\\nto 1.21 -->\n<g id=\"node3\" class=\"node\">\n<title>Upgrade k8s\\nto 1.21</title>\n<ellipse fill=\"none\" stroke=\"black\" cx=\"349.84\" cy=\"-29.42\" rx=\"61.74\" ry=\"29.33\"/>\n<text text-anchor=\"middle\" x=\"349.84\" y=\"-33.62\" font-family=\"Times,serif\" font-size=\"14.00\">Upgrade k8s</text>\n<text text-anchor=\"middle\" x=\"349.84\" y=\"-16.82\" font-family=\"Times,serif\" font-size=\"14.00\">to 1.21</text>\n</g>\n<!-- Upgrade k3d\\nto 4.x&#45;&gt;Upgrade k8s\\nto 1.21 -->\n<g id=\"edge2\" class=\"edge\">\n<title>Upgrade k3d\\nto 4.x&#45;&gt;Upgrade k8s\\nto 1.21</title>\n<path fill=\"none\" stroke=\"black\" d=\"M252.63,-29.42C260.94,-29.42 269.52,-29.42 277.97,-29.42\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"278.19,-32.92 288.19,-29.42 278.19,-25.92 278.19,-32.92\"/>\n</g>\n<!-- Update ingress\\nconfig -->\n<g id=\"node4\" class=\"node\">\n<title>Update ingress\\nconfig</title>\n<ellipse fill=\"none\" stroke=\"black\" cx=\"517.87\" cy=\"-29.42\" rx=\"70.33\" ry=\"29.33\"/>\n<text text-anchor=\"middle\" x=\"517.87\" y=\"-33.62\" font-family=\"Times,serif\" font-size=\"14.00\">Update ingress</text>\n<text text-anchor=\"middle\" x=\"517.87\" y=\"-16.82\" font-family=\"Times,serif\" font-size=\"14.00\">config</text>\n</g>\n<!-- Upgrade k8s\\nto 1.21&#45;&gt;Update ingress\\nconfig -->\n<g id=\"edge3\" class=\"edge\">\n<title>Upgrade k8s\\nto 1.21&#45;&gt;Update ingress\\nconfig</title>\n<path fill=\"none\" stroke=\"black\" d=\"M411.72,-29.42C420.04,-29.42 428.67,-29.42 437.26,-29.42\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"437.29,-32.92 447.29,-29.42 437.29,-25.92 437.29,-32.92\"/>\n</g>\n<!-- Write a\\nwiki page -->\n<g id=\"node5\" class=\"node\">\n<title>Write a\\nwiki page</title>\n<ellipse fill=\"none\" stroke=\"black\" cx=\"674.36\" cy=\"-29.42\" rx=\"50.15\" ry=\"29.33\"/>\n<text text-anchor=\"middle\" x=\"674.36\" y=\"-33.62\" font-family=\"Times,serif\" font-size=\"14.00\">Write a</text>\n<text text-anchor=\"middle\" x=\"674.36\" y=\"-16.82\" font-family=\"Times,serif\" font-size=\"14.00\">wiki page</text>\n</g>\n<!-- Update ingress\\nconfig&#45;&gt;Write a\\nwiki page -->\n<g id=\"edge4\" class=\"edge\">\n<title>Update ingress\\nconfig&#45;&gt;Write a\\nwiki page</title>\n<path fill=\"none\" stroke=\"black\" d=\"M588.44,-29.42C596.98,-29.42 605.64,-29.42 614.01,-29.42\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"614.05,-32.92 624.05,-29.42 614.05,-25.92 614.05,-32.92\"/>\n</g>\n</g>\n</svg>\n"
      },
      "date": 1624559693009
    },
    {
      "type": "add",
      "id": "8d4b3ebc365db3a1",
      "item": {
        "type": "paragraph",
        "id": "8d4b3ebc365db3a1",
        "text": "See also [[Yak Shaving]]"
      },
      "after": "b0543da838848298",
      "date": 1624560158394
    },
    {
      "type": "edit",
      "id": "8d4b3ebc365db3a1",
      "item": {
        "type": "paragraph",
        "id": "8d4b3ebc365db3a1",
        "text": "See also [[Yak Shaving]]."
      },
      "date": 1624560161617
    },
    {
      "type": "edit",
      "id": "b73186404973dbd7",
      "item": {
        "type": "paragraph",
        "id": "b73186404973dbd7",
        "text": "See [[Tempo Interruptions]]."
      },
      "date": 1624560163655
    },
    {
      "type": "edit",
      "id": "eb13233e57692c1a",
      "item": {
        "type": "code",
        "id": "eb13233e57692c1a",
        "text": "kubectl logs deployment/wiki-deployment\n\n"
      },
      "date": 1624560713544
    },
    {
      "type": "edit",
      "id": "eb13233e57692c1a",
      "item": {
        "type": "code",
        "id": "eb13233e57692c1a",
        "text": "kubectl  logs deployment/wiki-deployment\n\n"
      },
      "date": 1624560718764
    },
    {
      "type": "edit",
      "id": "eb13233e57692c1a",
      "item": {
        "type": "code",
        "id": "eb13233e57692c1a",
        "text": "kubectl logs deployment/wiki-deployment\n\n"
      },
      "date": 1624560722274
    },
    {
      "type": "fork",
      "site": "eric.dojo.fed.wiki",
      "date": 1707719642279
    }
  ]
}