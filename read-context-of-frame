{
  "title": "Read Context of Frame",
  "story": [
    {
      "type": "paragraph",
      "id": "54a39b1ea079b8c4",
      "text": "We send a message to the Frame asking it to send us info about the page surrounding it. [https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage mdn]"
    },
    {
      "type": "code",
      "id": "c8963fb39e7da82f",
      "text": "window.addEventListener(\"message\", handler)\nlet message = { action:\"sendFrameContext\" }\nwindow.parent.postMessage(message, \"*\")"
    },
    {
      "type": "paragraph",
      "id": "433e0069aa2ef6ee",
      "text": "We stop listening then process the data we got."
    },
    {
      "type": "code",
      "id": "00e55c113558b626",
      "text": "function handler ({data}) {\n  if (data.action == \"frameContext\") {\n    window.removeEventListener(\"message\", handler)\n    const {slug, item, page} = data\n    show(page)\n  }\n}"
    },
    {
      "type": "paragraph",
      "id": "ca075d681c953999",
      "text": "The page we show is the page on the screen which might be a ghost, maybe retrieved from history."
    },
    {
      "type": "code",
      "id": "d4ee6431abc012ac",
      "text": "function show (page) {\n  let plugins = page.story.map(item => item.type)\n  let html = `<pre>${plugins.join(\"\\n\")}</pre>`\n  output.innerHTML = html\n}"
    },
    {
      "type": "code",
      "id": "0231425262737ec2",
      "text": "function frameContext() {\n  return new Promise(resolve => {\n    let handler = event => {\n      let {data} = event\n      if (!data.action == \"frameContext\") return\n      window.removeEventListener('message',handler)\n      resolve(data)\n    }\n    window.addEventListener('message',handler)\n    window.parent.postMessage({action:\"sendFrameContext\"},\"*\")\n  })\n}"
    }
  ],
  "journal": [
    {
      "type": "create",
      "item": {
        "title": "Read Context of Frame",
        "story": [
          {
            "type": "paragraph",
            "id": "54a39b1ea079b8c4",
            "text": "Explain what this code does."
          },
          {
            "type": "code",
            "id": "c8963fb39e7da82f",
            "text": "2 + 3"
          },
          {
            "type": "frame",
            "id": "777ff878d8f1cc7e",
            "text": "http://js.ward.asia.wiki.org/assets/pages/snippet-template/basicjs.html?snippet-template\nHEIGHT 200"
          }
        ]
      },
      "date": 1616641418377
    },
    {
      "type": "edit",
      "id": "c8963fb39e7da82f",
      "item": {
        "type": "code",
        "id": "c8963fb39e7da82f",
        "text": "window.addEventListener(\"message\", handler)"
      },
      "date": 1616641506840
    },
    {
      "item": {
        "type": "factory",
        "id": "00e55c113558b626"
      },
      "id": "00e55c113558b626",
      "type": "add",
      "after": "777ff878d8f1cc7e",
      "date": 1616641535430
    },
    {
      "type": "edit",
      "id": "00e55c113558b626",
      "item": {
        "type": "code",
        "id": "00e55c113558b626",
        "text": "function handler ({data}) {\n  console.log(\"message received\", data)\n  window.removeEventListener(\"message\", handler)\n  if (data.action == \"frameContext\") {\n    const {slug, item, page} = data\n    let code = page.story.filter(it => it.type == 'code').map(it => it.text)\n    if (code.length) { render(code.join(\"\\n\")) }\n  }\n}"
      },
      "date": 1616641562809
    },
    {
      "id": "00e55c113558b626",
      "type": "move",
      "order": [
        "54a39b1ea079b8c4",
        "c8963fb39e7da82f",
        "00e55c113558b626",
        "777ff878d8f1cc7e"
      ],
      "date": 1616641589329
    },
    {
      "type": "edit",
      "id": "00e55c113558b626",
      "item": {
        "type": "code",
        "id": "00e55c113558b626",
        "text": "function handler ({data}) {\n  console.log(\"message received\", data)\n  window.removeEventListener(\"message\", handler)\n  if (data.action == \"frameContext\") {\n    const {slug, item, page} = data\n    output.innerHTML = slug\n  }\n}"
      },
      "date": 1616641890191
    },
    {
      "type": "edit",
      "id": "c8963fb39e7da82f",
      "item": {
        "type": "code",
        "id": "c8963fb39e7da82f",
        "text": "window.addEventListener(\"message\", handler)\nwindow.parent.postMessage({ action:\"sendFrameContext\" }, \"*\")"
      },
      "date": 1616641997051
    },
    {
      "type": "edit",
      "id": "00e55c113558b626",
      "item": {
        "type": "code",
        "id": "00e55c113558b626",
        "text": "function handler ({data}) {\n  window.removeEventListener(\"message\", handler)\n  if (data.action == \"frameContext\") {\n    const {slug, item, page} = data\n    output.innerHTML = slug\n  }\n}"
      },
      "date": 1616642074528
    },
    {
      "item": {
        "type": "factory",
        "id": "d4ee6431abc012ac"
      },
      "id": "d4ee6431abc012ac",
      "type": "add",
      "after": "777ff878d8f1cc7e",
      "date": 1616642078371
    },
    {
      "type": "edit",
      "id": "d4ee6431abc012ac",
      "item": {
        "type": "code",
        "id": "d4ee6431abc012ac",
        "text": "function show (page) {\n\n}"
      },
      "date": 1616642109461
    },
    {
      "type": "edit",
      "id": "d4ee6431abc012ac",
      "item": {
        "type": "code",
        "id": "d4ee6431abc012ac",
        "text": "function show (page) {\n  let plugins = page.story.map(item => item.type)\n  let html = `<pre>${plugins.join(\"\\n\")</pre>`\n  output.innerHTML = html\n}"
      },
      "date": 1616642270436
    },
    {
      "id": "d4ee6431abc012ac",
      "type": "move",
      "order": [
        "54a39b1ea079b8c4",
        "c8963fb39e7da82f",
        "00e55c113558b626",
        "d4ee6431abc012ac",
        "777ff878d8f1cc7e"
      ],
      "date": 1616642275614
    },
    {
      "type": "edit",
      "id": "00e55c113558b626",
      "item": {
        "type": "code",
        "id": "00e55c113558b626",
        "text": "function handler ({data}) {\n  window.removeEventListener(\"message\", handler)\n  if (data.action == \"frameContext\") {\n    const {slug, item, page} = data\n    show(page)\n  }\n}"
      },
      "date": 1616642313144
    },
    {
      "type": "edit",
      "id": "d4ee6431abc012ac",
      "item": {
        "type": "code",
        "id": "d4ee6431abc012ac",
        "text": "function show (page) {\n  let plugins = page.story.map(item => item.type)\n  let html = `<pre>${plugins.join(\"\\n\")}</pre>`\n  output.innerHTML = html\n}"
      },
      "date": 1616642318127
    },
    {
      "type": "edit",
      "id": "c8963fb39e7da82f",
      "item": {
        "type": "code",
        "id": "c8963fb39e7da82f",
        "text": "window.addEventListener(\"message\", handler)\nlet message = { action:\"sendFrameContext\" }\nwindow.parent.postMessage(message, \"*\")"
      },
      "date": 1616642405985
    },
    {
      "type": "edit",
      "id": "54a39b1ea079b8c4",
      "item": {
        "type": "paragraph",
        "id": "54a39b1ea079b8c4",
        "text": "We send a message to the Frame asking it to send us info about the surrounding page."
      },
      "date": 1616642592696
    },
    {
      "type": "edit",
      "id": "54a39b1ea079b8c4",
      "item": {
        "type": "paragraph",
        "id": "54a39b1ea079b8c4",
        "text": "We send a message to the Frame asking it to send us info about the page surrounding it."
      },
      "date": 1616642680269
    },
    {
      "type": "add",
      "id": "433e0069aa2ef6ee",
      "item": {
        "type": "paragraph",
        "id": "433e0069aa2ef6ee",
        "text": "We stop listening then process the data we got."
      },
      "after": "54a39b1ea079b8c4",
      "date": 1616642767157
    },
    {
      "id": "433e0069aa2ef6ee",
      "type": "move",
      "order": [
        "54a39b1ea079b8c4",
        "c8963fb39e7da82f",
        "433e0069aa2ef6ee",
        "00e55c113558b626",
        "d4ee6431abc012ac",
        "777ff878d8f1cc7e"
      ],
      "date": 1616642769883
    },
    {
      "type": "add",
      "id": "ca075d681c953999",
      "item": {
        "type": "paragraph",
        "id": "ca075d681c953999",
        "text": "The page we show is the page on the screen which might be a ghost, maybe retrieved from history."
      },
      "after": "433e0069aa2ef6ee",
      "date": 1616643131166
    },
    {
      "id": "ca075d681c953999",
      "type": "move",
      "order": [
        "54a39b1ea079b8c4",
        "c8963fb39e7da82f",
        "433e0069aa2ef6ee",
        "00e55c113558b626",
        "ca075d681c953999",
        "d4ee6431abc012ac",
        "777ff878d8f1cc7e"
      ],
      "date": 1616643137955
    },
    {
      "type": "edit",
      "id": "00e55c113558b626",
      "item": {
        "type": "code",
        "id": "00e55c113558b626",
        "text": "function handler ({data}) {\n  if (data.action == \"frameContext\") {\n    window.removeEventListener(\"message\", handler)\n    const {slug, item, page} = data\n    show(page)\n  }\n}"
      },
      "date": 1616644340755
    },
    {
      "type": "edit",
      "id": "54a39b1ea079b8c4",
      "item": {
        "type": "paragraph",
        "id": "54a39b1ea079b8c4",
        "text": "We send a message to the Frame asking it to send us info about the page surrounding it. [https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage mdn]"
      },
      "date": 1616683248671
    },
    {
      "item": {
        "type": "factory",
        "id": "a8e4865347a09924"
      },
      "id": "a8e4865347a09924",
      "type": "add",
      "after": "777ff878d8f1cc7e",
      "date": 1626813952534
    },
    {
      "type": "remove",
      "id": "a8e4865347a09924",
      "date": 1626813966294
    },
    {
      "item": {
        "type": "factory",
        "id": "0231425262737ec2"
      },
      "id": "0231425262737ec2",
      "type": "add",
      "after": "777ff878d8f1cc7e",
      "date": 1626813985540
    },
    {
      "type": "edit",
      "id": "0231425262737ec2",
      "item": {
        "type": "code",
        "id": "0231425262737ec2",
        "text": "function frameContext() {\n  return new Promise(resolve => {\n    let handler = event => {\n      let {data} = event\n      if (!data.action == \"frameContext\") return\n      window.removeEventListener('message',handler)\n      resolve(data)\n    }\n    window.addEventListener('message',handler)\n    window.parent.postMessage({action:\"sendFrameContext\"},\"*\")\n  })\n}"
      },
      "date": 1626813989125
    },
    {
      "type": "fork",
      "site": "js.ward.asia.wiki.org",
      "date": 1637928924818
    },
    {
      "type": "edit",
      "id": "777ff878d8f1cc7e",
      "item": {
        "type": "frame",
        "id": "777ff878d8f1cc7e",
        "text": "//wiki.ralfbarkow.ch/assets/pages/snippet-template/basicjs.html?snippet-template\nHEIGHT 200"
      },
      "date": 1678713859244
    },
    {
      "type": "fork",
      "date": 1679059440813
    },
    {
      "id": "777ff878d8f1cc7e",
      "type": "remove",
      "removedTo": {
        "page": "2023-03-20"
      },
      "date": 1679320451915
    }
  ]
}